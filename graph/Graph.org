* Graph
This program generates graphs from stored entries in postgres. It would be fairly straightforward to have this parse cdf
or Sqlite entries, but for now only psql is supported.

#+begin_src c++ :tangle Graph.cpp
import Postgres;
import Config;
import parse_date;
import Cursor;
import SummaryData;
import TrafficGraph;

import <print>;

using namespace bandwidthd;
using namespace lpprogramming;
using namespace std::string_literals;

int Main(int argc, char **argv) {
  Config config{};
  size_t s_argc = static_cast<size_t>(argc);

  const std::vector<std::string> args{argv, argv + argc};
  if (argc < 5 || !(argc % 2)) {
    std::println("Usage: {} --start <START> --end <END> [--subnet <SUBNET> ..] ", args.at(0));
    return 1;
  }

  bool relative_start{false};
  bool relative_end{false};
  std::string start{};
  std::string end{};
  std::vector<std::string> subnets{};
  
  for (size_t i = 1; i < s_argc; i += 2 ) {
    std::string_view arg = args[i];
    if (arg == "--start") {
      start = args.at(i + 1);
      if (start.starts_with("-")) {
        relative_start = true;
        start = start.substr(1);
      }
    }
    if (arg == "--end"s) {
      end = args.at(i + 1);
      if (end.starts_with("-")) {
        relative_end = true;
        end = end.substr(1);
      }
    }
    if (arg == "--subnet"s) {
      auto& sn = subnets.emplace_back(args.at(i + 1));
      std::println("Graphing subnet {}", sn);
    }
  }

  Cursor<PostgresDB> db{config};
  for (auto& sn: subnets) {
    auto st = util::parse_timestamp(start);
    auto et = util::parse_timestamp(end);
    std::println("st: {}", st);

    std::vector<SummaryData> res = db.GetData(start, end, relative_start, relative_end, sn, "rx", "ip");
    TrafficGraph tg{
      {.width=1920,
       .height=1080,
       .left_margin=150,
       .top_margin=100,
       .bottom_margin=50,
       .right_margin=50,
       .timezone = util::parse_timezone(util::get_timezone("now"))}};

    std::println("{}", tg.Render(res, st, et));
  }
               
  return 0;
}

int main(int argc, char **argv) {
  return Main(argc, argv);
}
#+end_src
